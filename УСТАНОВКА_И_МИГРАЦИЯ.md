# Полная инструкция по установке и миграции

## Шаг 1: Установка EF Core Tools

```bash
cd /home/siteadmin/cloudcity/CloudCityCenter

# Установите EF Core tools глобально
dotnet tool install --global dotnet-ef

# Или локально для проекта
dotnet tool install dotnet-ef

# Проверьте установку
dotnet ef --version
```

## Шаг 2: Удаление таблиц в правильном порядке

В SQL Server Management Studio выполните этот скрипт (учитывает внешние ключи):

```sql
USE CloudCityDB;
GO

-- Удаляем таблицы в правильном порядке (сначала дочерние, потом родительские)

-- 1. Удаляем таблицы с внешними ключами к Products
DROP TABLE IF EXISTS ProductFeatures;
DROP TABLE IF EXISTS ProductVariants;
GO

-- 2. Удаляем таблицы с внешними ключами к Orders
DROP TABLE IF EXISTS OrderItems;
DROP TABLE IF EXISTS Orders;
GO

-- 3. Удаляем основные таблицы
DROP TABLE IF EXISTS Products;
DROP TABLE IF EXISTS Servers;
GO

-- 4. Удаляем Identity таблицы (сначала дочерние)
DROP TABLE IF EXISTS AspNetUserClaims;
DROP TABLE IF EXISTS AspNetUserLogins;
DROP TABLE IF EXISTS AspNetUserRoles;
DROP TABLE IF EXISTS AspNetUserTokens;
DROP TABLE IF EXISTS AspNetRoleClaims;
DROP TABLE IF EXISTS AspNetRoles;
DROP TABLE IF EXISTS AspNetUsers;
GO

-- 5. Удаляем таблицу миграций
DROP TABLE IF EXISTS __EFMigrationsHistory;
GO

PRINT 'Все таблицы удалены успешно';
GO
```

## Шаг 3: Создание новой миграции для SQL Server

```bash
cd /home/siteadmin/cloudcity/CloudCityCenter

# Установите окружение
export ASPNETCORE_ENVIRONMENT=Production

# Установите строку подключения
export ConnectionStrings__DefaultConnection="Server=10.151.10.8;Database=CloudCityDB;User Id=sa;Password=ВАШ_ПАРОЛЬ;TrustServerCertificate=True;MultipleActiveResultSets=true"

# Удалите старые миграции (если еще не удалили)
rm -rf Migrations

# Создайте новую миграцию для SQL Server
dotnet ef migrations add InitialCreateForSqlServer

# Примените миграцию
dotnet ef database update

# Загрузите данные
dotnet run -- --migrate-data
```

## Альтернатива: Если dotnet ef не работает

Если `dotnet ef` не устанавливается, можно создать таблицы вручную через SQL скрипт или использовать встроенную миграцию приложения.












