-- =============================================
-- SQL ЗАПРОСЫ ДЛЯ ОБНОВЛЕНИЯ ТОВАРОВ ХОСТИНГА
-- =============================================

-- ВАЖНО: Перед выполнением убедитесь, что вы подключены к базе данных CloudCityDB!
-- В SQL Server Management Studio выберите базу данных CloudCityDB в выпадающем списке.

USE CloudCityDB;
GO

-- =============================================
-- ШАГ 1: Обновить Location для товаров хостинга
-- =============================================

-- Обновить Location на "Netherlands" для всех товаров хостинга
UPDATE Products 
SET Location = 'Netherlands'
WHERE Type = 1;
GO

-- Исправить Location, если там знаки вопроса (проблемы с кодировкой)
UPDATE Products 
SET Location = 'Netherlands'
WHERE Type = 1 AND (Location LIKE '%?%' OR Location = 'Нидерланды');
GO

-- =============================================
-- ШАГ 2: Удалить старые фичи для "Basic Hosting"
-- =============================================

DELETE FROM ProductFeatures 
WHERE ProductId IN (
    SELECT Id FROM Products WHERE Slug = 'basic-hosting' AND Type = 1
)
AND Name IN ('Storage', 'Email Accounts', 'Трафик', 'Страна', 'Гео');
GO

-- Обновить существующие записи "Трафик" на "Bandwidth" для всех товаров хостинга
UPDATE ProductFeatures
SET Name = 'Bandwidth'
WHERE ProductId IN (SELECT Id FROM Products WHERE Type = 1)
AND Name = 'Трафик';
GO

-- Обновить существующие записи "Страна" или "Гео" на "Country" для всех товаров хостинга
UPDATE ProductFeatures
SET Name = 'Country', Value = 'Netherlands'
WHERE ProductId IN (SELECT Id FROM Products WHERE Type = 1)
AND (Name = 'Страна' OR Name = 'Гео' OR Name LIKE '%?%');
GO

-- =============================================
-- ШАГ 3: Добавить новые фичи для "Basic Hosting"
-- =============================================

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    Id AS ProductId,
    'CPU' AS Name,
    '1 Core' AS Value
FROM Products 
WHERE Slug = 'basic-hosting' AND Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = Products.Id AND Name = 'CPU'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    Id AS ProductId,
    'RAM' AS Name,
    '1 GB' AS Value
FROM Products 
WHERE Slug = 'basic-hosting' AND Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = Products.Id AND Name = 'RAM'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    Id AS ProductId,
    'SSD (NVMe)' AS Name,
    '10 GB' AS Value
FROM Products 
WHERE Slug = 'basic-hosting' AND Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = Products.Id AND Name = 'SSD (NVMe)'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    Id AS ProductId,
    'OS' AS Name,
    'Linux' AS Value
FROM Products 
WHERE Slug = 'basic-hosting' AND Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = Products.Id AND Name = 'OS'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    Id AS ProductId,
    'Bandwidth' AS Name,
    '100 GB' AS Value
FROM Products 
WHERE Slug = 'basic-hosting' AND Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = Products.Id AND Name = 'Bandwidth'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    Id AS ProductId,
    'Country' AS Name,
    'Netherlands' AS Value
FROM Products 
WHERE Slug = 'basic-hosting' AND Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = Products.Id AND Name = 'Country'
);
GO

-- =============================================
-- ШАГ 4: Добавить новые товары хостинга (опционально)
-- =============================================

-- Premium Hosting
INSERT INTO Products (Name, Slug, Type, Location, PricePerMonth, Configuration, IsAvailable, IsPublished, ImageUrl)
SELECT 
    'Premium Hosting',
    'premium-hosting',
    1,
    'Netherlands',
    25.00,
    'Shared hosting premium',
    1,
    1,
    '/images/hosting-premium.png'
WHERE NOT EXISTS (
    SELECT 1 FROM Products WHERE Slug = 'premium-hosting'
);
GO

-- Фичи для Premium Hosting
INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'CPU' AS Name,
    '2 Cores' AS Value
FROM Products p
WHERE p.Slug = 'premium-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'CPU'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'RAM' AS Name,
    '2 GB' AS Value
FROM Products p
WHERE p.Slug = 'premium-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'RAM'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'SSD (NVMe)' AS Name,
    '50 GB' AS Value
FROM Products p
WHERE p.Slug = 'premium-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'SSD (NVMe)'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'OS' AS Name,
    'Linux' AS Value
FROM Products p
WHERE p.Slug = 'premium-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'OS'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'Bandwidth' AS Name,
    '500 GB' AS Value
FROM Products p
WHERE p.Slug = 'premium-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'Bandwidth'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'Country' AS Name,
    'Netherlands' AS Value
FROM Products p
WHERE p.Slug = 'premium-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'Country'
);
GO

-- Business Hosting
INSERT INTO Products (Name, Slug, Type, Location, PricePerMonth, Configuration, IsAvailable, IsPublished, ImageUrl)
SELECT 
    'Business Hosting',
    'business-hosting',
    1,
    'Netherlands',
    50.00,
    'Shared hosting business',
    1,
    1,
    '/images/hosting-business.png'
WHERE NOT EXISTS (
    SELECT 1 FROM Products WHERE Slug = 'business-hosting'
);
GO

-- Фичи для Business Hosting
INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'CPU' AS Name,
    '4 Cores' AS Value
FROM Products p
WHERE p.Slug = 'business-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'CPU'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'RAM' AS Name,
    '4 GB' AS Value
FROM Products p
WHERE p.Slug = 'business-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'RAM'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'SSD (NVMe)' AS Name,
    '100 GB' AS Value
FROM Products p
WHERE p.Slug = 'business-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'SSD (NVMe)'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'OS' AS Name,
    'Linux / Windows' AS Value
FROM Products p
WHERE p.Slug = 'business-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'OS'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'Bandwidth' AS Name,
    '1 TB' AS Value
FROM Products p
WHERE p.Slug = 'business-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'Bandwidth'
);
GO

INSERT INTO ProductFeatures (ProductId, Name, Value)
SELECT 
    p.Id AS ProductId,
    'Country' AS Name,
    'Netherlands' AS Value
FROM Products p
WHERE p.Slug = 'business-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductFeatures 
    WHERE ProductId = p.Id AND Name = 'Country'
);
GO

-- =============================================
-- ШАГ 5: Добавить варианты оплаты (ProductVariants)
-- =============================================

-- Варианты для Basic Hosting
INSERT INTO ProductVariants (ProductId, Name, Price, BillingPeriod)
SELECT 
    p.Id AS ProductId,
    'Monthly' AS Name,
    10.00 AS Price,
    0 AS BillingPeriod
FROM Products p
WHERE p.Slug = 'basic-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductVariants 
    WHERE ProductId = p.Id AND Name = 'Monthly'
);
GO

-- Варианты для Premium Hosting
INSERT INTO ProductVariants (ProductId, Name, Price, BillingPeriod)
SELECT 
    p.Id AS ProductId,
    'Monthly' AS Name,
    25.00 AS Price,
    0 AS BillingPeriod
FROM Products p
WHERE p.Slug = 'premium-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductVariants 
    WHERE ProductId = p.Id AND Name = 'Monthly'
);
GO

-- Варианты для Business Hosting
INSERT INTO ProductVariants (ProductId, Name, Price, BillingPeriod)
SELECT 
    p.Id AS ProductId,
    'Monthly' AS Name,
    50.00 AS Price,
    0 AS BillingPeriod
FROM Products p
WHERE p.Slug = 'business-hosting' AND p.Type = 1
AND NOT EXISTS (
    SELECT 1 FROM ProductVariants 
    WHERE ProductId = p.Id AND Name = 'Monthly'
);
GO

-- =============================================
-- ПРОВЕРКА РЕЗУЛЬТАТОВ
-- =============================================

-- Проверить все товары хостинга
SELECT Id, Name, Slug, PricePerMonth, Location 
FROM Products 
WHERE Type = 1;
GO

-- Проверить фичи для Basic Hosting
SELECT pf.Name, pf.Value 
FROM ProductFeatures pf
INNER JOIN Products p ON pf.ProductId = p.Id
WHERE p.Slug = 'basic-hosting' AND p.Type = 1
ORDER BY 
    CASE pf.Name
        WHEN 'CPU' THEN 1
        WHEN 'RAM' THEN 2
        WHEN 'SSD (NVMe)' THEN 3
        WHEN 'OS' THEN 4
        WHEN 'Bandwidth' THEN 5
        WHEN 'Country' THEN 6
        ELSE 99
    END;
GO

-- =============================================
-- ОБНОВЛЕНИЕ ИЗОБРАЖЕНИЙ ДЛЯ ТОВАРОВ ХОСТИНГА
-- =============================================

-- Обновить изображение для Basic Hosting
UPDATE Products 
SET ImageUrl = '/images/hosting1.png'
WHERE Slug = 'basic-hosting' AND Type = 1;
GO

-- Обновить изображение для Business Hosting
UPDATE Products 
SET ImageUrl = '/images/hosting2.png'
WHERE Slug = 'business-hosting' AND Type = 1;
GO

-- Обновить изображение для Premium Hosting
UPDATE Products 
SET ImageUrl = '/images/hosting3.png'
WHERE Slug = 'premium-hosting' AND Type = 1;
GO

-- Проверить изображения для всех товаров хостинга
SELECT Id, Name, Slug, ImageUrl 
FROM Products 
WHERE Type = 1
ORDER BY PricePerMonth;
GO
