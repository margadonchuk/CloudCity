@model CloudCityCenter.Models.ViewModels.CartViewModel
@using System
@{
    ViewData["Title"] = Localizer["Title"];
}

<!-- CART HERO SECTION -->
<section class="cart-hero-section py-4 position-relative">
  <div class="cart-hero-background"></div>
  <div class="container">
    <div class="text-center animate-on-scroll" data-animation="fade-in-up">
      <h1 class="display-4 fw-bold mb-2 cart-hero-title">
        <i class="bi bi-cart-check me-2"></i>
        <span class="text-gradient-2">@Localizer["ShoppingCart"]</span>
      </h1>
      <p class="text-muted">@Localizer["ReviewItems"]</p>
    </div>
  </div>
</section>

<!-- CART CONTENT -->
<section class="cart-content-section py-5">
  <div class="container">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model.Items.Any())
    {
        <div class="row">
          <!-- Cart Items -->
          <div class="col-lg-8 mb-4">
            <div class="cart-items-wrapper">
              @for (int i = 0; i < Model.Items.Count; i++)
              {
                  var item = Model.Items[i];
                  <div class="cart-item-card animate-on-scroll" data-animation="fade-in-up">
                    <div class="cart-item-image-wrapper">
                      <img src="@(item.Product?.ImageUrl ?? "https://via.placeholder.com/300x200?text=No+Image")" 
                           alt="@item.Product?.Name" 
                           class="cart-item-image"
                           onerror="this.onerror=null;this.src='https://via.placeholder.com/300x200?text=No+Image';" />
                      <div class="cart-item-badge">
                        <i class="bi bi-check-circle-fill"></i>
                      </div>
                    </div>
                    <div class="cart-item-content">
                      <div class="cart-item-header">
                        <h3 class="cart-item-title">@item.Product?.Name</h3>
                        @if (!string.IsNullOrEmpty(item.ProductVariant?.Name))
                        {
                            <span class="cart-item-variant badge bg-primary">@item.ProductVariant.Name</span>
                        }
                        @{
                            // Проверяем, является ли это услугой настройки Windows Server (только по slug)
                            // CHR, MikroTik, Fortinet - это ежемесячные услуги, не единоразовые
                            var isWindowsServerSetupService = item.Product != null && 
                                                             !string.IsNullOrEmpty(item.Product.Slug) &&
                                                             item.Product.Slug.StartsWith("windows-server-setup-", StringComparison.OrdinalIgnoreCase);
                        }
                        @if (isWindowsServerSetupService)
                        {
                            <div class="mt-2">
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-info-circle me-1"></i>@Localizer["OneTimePayment"]
                                </span>
                                <small class="d-block text-muted mt-1" style="font-size: 0.85rem;">
                                    <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>@Localizer["OneTimePaymentDescription"]
                                </small>
                            </div>
                        }
                      </div>
                      <div class="cart-item-footer">
                        <div class="cart-item-price">
                          <span class="price-label">@Localizer["Price"]</span>
                          <span class="price-value">$@item.Item.Price.ToString("F2")</span>
                        </div>
                        <form asp-action="Remove" method="post" class="cart-item-remove">
                          @Html.AntiForgeryToken()
                          <input type="hidden" name="index" value="@i" />
                          <button type="submit" class="btn btn-danger btn-sm cart-remove-btn" title="@Localizer["Remove"]">
                            <i class="bi bi-trash me-1"></i>@Localizer["Remove"]
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
              }
            </div>

            <!-- Action Buttons -->
            <div class="cart-actions mt-4 animate-on-scroll" data-animation="fade-in-up">
              <div class="d-flex flex-wrap gap-3">
                <a asp-controller="Servers" asp-action="Index" class="btn btn-outline-primary btn-lg">
                  <i class="bi bi-arrow-left me-2"></i>@Localizer["ContinueShopping"]
                </a>
                <form asp-action="Clear" method="post" class="d-inline">
                  @Html.AntiForgeryToken()
                  <button type="submit" class="btn btn-outline-danger btn-lg" onclick="return confirm('@Localizer["ClearCartConfirm"]');">
                    <i class="bi bi-x-circle me-2"></i>@Localizer["ClearCart"]
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- Cart Summary -->
          <div class="col-lg-4">
            <div class="cart-summary-card animate-on-scroll" data-animation="fade-in-up">
              <div class="cart-summary-header">
                <h3 class="cart-summary-title">
                  <i class="bi bi-receipt me-2"></i>@Localizer["OrderSummary"]
                </h3>
              </div>
              <div class="cart-summary-body">
                <div class="cart-summary-item">
                  <span class="summary-label">@Localizer["Items"]</span>
                  <span class="summary-value">@Model.Items.Count</span>
                </div>
                <div class="cart-summary-divider"></div>
                <div class="cart-summary-total">
                  <span class="total-label">@Localizer["Total"]</span>
                  <span class="total-value">$@Model.Total.ToString("F2")</span>
                </div>
              </div>
              <div class="cart-summary-footer">
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <form asp-action="Checkout" method="post">
                      @Html.AntiForgeryToken()
                      <button type="submit" class="btn btn-primary btn-lg w-100 checkout-btn">
                        <i class="bi bi-credit-card me-2"></i>@Localizer["ProceedToCheckout"]
                      </button>
                    </form>
                }
                else
                {
                    <div class="alert alert-info mb-3">
                      <i class="bi bi-info-circle me-2"></i>
                      @Localizer["PleaseSignIn"] <a asp-controller="Account" asp-action="Login" class="alert-link">@Localizer["SignIn"]</a> @Localizer["ToCheckout"]
                    </div>
                    <a asp-controller="Account" asp-action="Login" class="btn btn-primary btn-lg w-100">
                      <i class="bi bi-box-arrow-in-right me-2"></i>@Localizer["SignInToCheckout"]
                    </a>
                }
              </div>
            </div>
          </div>
        </div>
    }
    else
    {
        <div class="cart-empty-wrapper animate-on-scroll" data-animation="fade-in-up">
          <div class="cart-empty-card text-center">
            <div class="cart-empty-icon mb-4">
              <i class="bi bi-cart-x"></i>
            </div>
            <h2 class="cart-empty-title mb-3">@Localizer["CartEmpty"]</h2>
            <p class="text-muted mb-4">@Localizer["CartEmptyDescription"]</p>
            <a asp-controller="Servers" asp-action="Index" class="btn btn-primary btn-lg">
              <i class="bi bi-arrow-left me-2"></i>@Localizer["StartShopping"]
            </a>
          </div>
        </div>
    }
  </div>
</section>
