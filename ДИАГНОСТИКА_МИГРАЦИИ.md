# Диагностика проблем с миграцией данных

## Проблема: данные не загружаются

Если команда `dotnet run -- --migrate-data` не загружает данные, выполните следующие шаги:

## Шаг 1: Проверка строки подключения

Убедитесь, что строка подключения настроена правильно:

```bash
# Проверка переменной окружения
echo $ConnectionStrings__DefaultConnection

# Или проверка файла
cat CloudCityCenter/appsettings.Production.json | grep -A 2 "ConnectionStrings"
```

Строка подключения должна быть в формате:
```
Server=10.151.10.8;Database=CloudCityDB;User Id=sa;Password=ВАШ_ПАРОЛЬ;TrustServerCertificate=True;MultipleActiveResultSets=true
```

## Шаг 2: Проверка подключения к SQL Server

Проверьте, что SQL Server доступен с сервера сайта:

```bash
# Проверка доступности порта SQL Server (обычно 1433)
telnet 10.151.10.8 1433
# или
nc -zv 10.151.10.8 1433
```

## Шаг 3: Запуск с подробным выводом

Запустите миграцию с подробным выводом:

```bash
cd CloudCityCenter
export ASPNETCORE_ENVIRONMENT=Production
dotnet run -- --migrate-data
```

Теперь вы увидите подробную информацию:
- ✓ Строка подключения найдена
- ✓ Подключение к базе данных успешно
- ✓ Миграции применены
- Найдено товаров в базе: X
- Загрузка товаров и услуг...

## Шаг 4: Проверка базы данных напрямую

Подключитесь к SQL Server и проверьте:

```sql
USE CloudCityDB;
GO

-- Проверка существования таблиц
SELECT TABLE_NAME 
FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_TYPE = 'BASE TABLE'
ORDER BY TABLE_NAME;
GO

-- Проверка товаров
SELECT COUNT(*) as ProductsCount FROM Products;
SELECT COUNT(*) as VariantsCount FROM ProductVariants;
SELECT COUNT(*) as FeaturesCount FROM ProductFeatures;
GO

-- Список товаров
SELECT Id, Name, Type, PricePerMonth FROM Products;
GO
```

## Шаг 5: Ручная проверка подключения

Создайте тестовый скрипт для проверки подключения:

```bash
cd CloudCityCenter
export ASPNETCORE_ENVIRONMENT=Production

# Создайте временный файл test-connection.cs
cat > test-connection.cs << 'EOF'
using Microsoft.EntityFrameworkCore;
using CloudCityCenter.Data;

var builder = WebApplication.CreateBuilder(args);
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");
Console.WriteLine($"Connection String: {connectionString?.Substring(0, Math.Min(50, connectionString?.Length ?? 0))}...");

builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(connectionString));

var app = builder.Build();
using var scope = app.Services.CreateScope();
var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();

try
{
    var canConnect = await context.Database.CanConnectAsync();
    Console.WriteLine($"Can Connect: {canConnect}");
    
    if (canConnect)
    {
        var productsCount = await context.Products.CountAsync();
        Console.WriteLine($"Products in DB: {productsCount}");
    }
}
catch (Exception ex)
{
    Console.WriteLine($"Error: {ex.Message}");
}
EOF
```

## Частые проблемы и решения

### Проблема 1: "ConnectionStrings__DefaultConnection is not set"

**Решение:**
```bash
# Установите переменную окружения
export ConnectionStrings__DefaultConnection="Server=10.151.10.8;Database=CloudCityDB;User Id=sa;Password=ВАШ_ПАРОЛЬ;TrustServerCertificate=True;MultipleActiveResultSets=true"

# Или обновите appsettings.Production.json
nano CloudCityCenter/appsettings.Production.json
```

### Проблема 2: "Cannot connect to database"

**Возможные причины:**
1. SQL Server не доступен с сервера сайта
2. Неправильный IP адрес или порт
3. Firewall блокирует подключение
4. Неправильный логин/пароль

**Решение:**
```bash
# Проверьте доступность
ping 10.151.10.8
telnet 10.151.10.8 1433

# Проверьте настройки SQL Server:
# - TCP/IP должен быть включен
# - SQL Server должен слушать на правильном порту
# - Firewall должен разрешать подключения
```

### Проблема 3: "Товары уже загружены" (но их нет)

**Решение:**
```sql
-- Удалите все товары (осторожно!)
USE CloudCityDB;
DELETE FROM ProductFeatures;
DELETE FROM ProductVariants;
DELETE FROM Products;
GO
```

Затем запустите миграцию снова.

### Проблема 4: Таблицы не созданы

**Решение:**
```bash
cd CloudCityCenter
export ASPNETCORE_ENVIRONMENT=Production

# Примените миграции вручную
dotnet ef database update

# Или запустите приложение - миграции применятся автоматически
dotnet run
```

## Использование SQL скрипта напрямую

Если автоматическая миграция не работает, используйте SQL скрипт:

1. Подключитесь к SQL Server Management Studio на `10.151.10.8`
2. Откройте файл `migrate_products_to_sql.sql`
3. Выполните скрипт (F5)

Это гарантированно загрузит все данные.

## Проверка после миграции

После успешной миграции проверьте:

```sql
USE CloudCityDB;
GO

-- Должно быть 16 товаров
SELECT COUNT(*) FROM Products;
-- Ожидается: 16

-- Должно быть 16 вариантов (по одному на товар)
SELECT COUNT(*) FROM ProductVariants;
-- Ожидается: 16

-- Должно быть много характеристик
SELECT COUNT(*) FROM ProductFeatures;
-- Ожидается: ~80-100

-- Список всех товаров
SELECT 
    p.Id,
    p.Name,
    p.Type,
    p.PricePerMonth,
    p.Location,
    COUNT(DISTINCT pv.Id) as VariantsCount,
    COUNT(DISTINCT pf.Id) as FeaturesCount
FROM Products p
LEFT JOIN ProductVariants pv ON p.Id = pv.ProductId
LEFT JOIN ProductFeatures pf ON p.Id = pf.ProductId
GROUP BY p.Id, p.Name, p.Type, p.PricePerMonth, p.Location
ORDER BY p.Type, p.Name;
GO
```

## Логирование

Все сообщения теперь выводятся в консоль. Если что-то не работает, вы увидите:
- ❌ ОШИБКА: ... (красные сообщения об ошибках)
- ⚠ ... (предупреждения)
- ✓ ... (успешные операции)

Скопируйте весь вывод команды и проверьте, на каком этапе происходит ошибка.













